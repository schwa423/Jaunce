<!doctype html>
<html>
  <head>
    <title>Demo</title>    
    <meta charset="utf-8">
    <style type="text/css">
      body {
        background-color: #004488;
      }
      canvas {
        background-color: #008844;
      }
    </style>
  </head>
  <body>

  <script src="js/vendor/Three.js"></script>

<!-- FOR DEBUGGING WITH THREE.JS SOURCE-CODE
    <script type="text/javascript" src="../three.js/src/Three.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Color.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Vector2.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Vector3.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Vector4.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Ray.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Rectangle.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Matrix3.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Matrix4.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Object3D.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Quaternion.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Vertex.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Face3.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Face4.js"></script>
    <script type="text/javascript" src="../three.js/src/core/UV.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Geometry.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Spline.js"></script>
    <script type="text/javascript" src="../three.js/src/core/Edge.js"></script>
    <script type="text/javascript" src="../three.js/src/cameras/Camera.js"></script>
    <script type="text/javascript" src="../three.js/src/lights/Light.js"></script>
    <script type="text/javascript" src="../three.js/src/lights/AmbientLight.js"></script>
    <script type="text/javascript" src="../three.js/src/lights/DirectionalLight.js"></script>
    <script type="text/javascript" src="../three.js/src/lights/PointLight.js"></script>
    <script type="text/javascript" src="../three.js/src/lights/LensFlare.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/Material.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/Mappings.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/LineBasicMaterial.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/MeshBasicMaterial.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/MeshLambertMaterial.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/MeshPhongMaterial.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/MeshDepthMaterial.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/MeshNormalMaterial.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/MeshFaceMaterial.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/MeshShaderMaterial.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/ParticleBasicMaterial.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/ShadowVolumeDynamicMaterial.js"></script>
    <script type="text/javascript" src="../three.js/src/materials/Texture.js"></script>
    <script type="text/javascript" src="../three.js/src/objects/Particle.js"></script>
    <script type="text/javascript" src="../three.js/src/objects/ParticleSystem.js"></script>
    <script type="text/javascript" src="../three.js/src/objects/Line.js"></script>
    <script type="text/javascript" src="../three.js/src/objects/Mesh.js"></script>
    <script type="text/javascript" src="../three.js/src/objects/Bone.js"></script>
    <script type="text/javascript" src="../three.js/src/objects/SkinnedMesh.js"></script>
    <script type="text/javascript" src="../three.js/src/objects/Ribbon.js"></script>
    <script type="text/javascript" src="../three.js/src/objects/LOD.js"></script>
    <script type="text/javascript" src="../three.js/src/objects/ShadowVolume.js"></script>
    <script type="text/javascript" src="../three.js/src/objects/Sprite.js"></script>
    <script type="text/javascript" src="../three.js/src/scenes/Scene.js"></script>
    <script type="text/javascript" src="../three.js/src/scenes/Fog.js"></script>
    <script type="text/javascript" src="../three.js/src/scenes/FogExp2.js"></script>
    <script type="text/javascript" src="../three.js/src/renderers/Projector.js"></script>
    <script type="text/javascript" src="../three.js/src/renderers/WebGLShaders.js"></script>
    <script type="text/javascript" src="../three.js/src/renderers/WebGLRenderer.js"></script>
    <script type="text/javascript" src="../three.js/src/renderers/WebGLRenderTarget.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/ColorUtils.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/GeometryUtils.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/ImageUtils.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/SceneUtils.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/ShaderUtils.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/animation/AnimationHandler.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/animation/Animation.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/cameras/FirstPersonCamera.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/cameras/PathCamera.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/cameras/FlyCamera.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/cameras/RollCamera.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/cameras/TrackballCamera.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/cameras/QuakeCamera.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/geometries/CubeGeometry.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/geometries/CylinderGeometry.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/geometries/IcosahedronGeometry.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/geometries/LatheGeometry.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/geometries/PlaneGeometry.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/geometries/SphereGeometry.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/geometries/TextGeometry.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/geometries/TorusGeometry.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/geometries/TorusKnotGeometry.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/io/Loader.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/io/JSONLoader.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/io/BinaryLoader.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/io/SceneLoader.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/objects/MarchingCubes.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/objects/Trident.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/physics/Collisions.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/physics/CollisionUtils.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/renderers/AnaglyphWebGLRenderer.js"></script>
    <script type="text/javascript" src="../three.js/src/extras/renderers/CrosseyedWebGLRenderer.js"></script>
-->

    <script src="js/vendor/jquery-1.6.2.js"></script>
    <script src="js/vendor/joose-3.18.0-Core.js"></script> 
    <script src="js/three-extensions/ToString.js"></script>
    <script src="js/sketch/Page.js"></script>
    <script type="text/javascript">
    var container, stats;

    var camera, scene, projector, renderer, page;
    var eventQueue = [];

    // D'oh... Chrome doesn't support requestAnimationFrame() yet.  
    // (they would perfer a per-div version, instead of one for the whole window).
    window.requestAnimationFrame = window.requestAnimationFrame || function(callback) { setTimeout(callback, 10); }

    init();
    animate();

    function init() {
      var spacer = document.createElement("div");
      spacer.style.width = spacer.style.height = "100px";
      document.body.appendChild(spacer);

      container = document.createElement("div");
      container.style.left = "100px";
      container.style.width = "800px";
      container.style.height = "600px";
      document.body.appendChild(container);
      container.addEventListener("mousedown", onMouseDown, false);
      projector = new THREE.Projector();

      camera = new THREE.Camera(40, container.clientWidth / container.clientHeight, 1, 10000);
      camera.position.z = 2;

      projector = new THREE.Projector();

      scene = new THREE.Scene();

      // Create a page, and rotate it to prove that our picking is working properly.
      page = new Page({width: 1.5, height: 1});
      var pageRotation = new THREE.Quaternion();
      pageRotation.setFromAxisAngle( (new THREE.Vector3(0, 1, 3)).normalize(), 0.75);
      page.quaternion = pageRotation;
      page.useQuaternion = true;
      page.updateMatrix();

      scene.addObject(page);

      renderer = new THREE.WebGLRenderer();
      renderer.sortObjects = false;
      renderer.setSize(container.clientWidth, container.clientHeight);

      container.appendChild(renderer.domElement);

    }

    function onMouseDown(event) {
      event.preventDefault();

      var x = event.clientX - container.offsetLeft;
      var y = event.clientY - container.offsetTop;
      x = x / container.clientWidth * 2 - 1;
      y = y / container.clientHeight * -2 + 1;

      eventQueue.push({ 
        type: "mouseDown",
        original: event,
        time: Date.now(),
        x: x,
        y: y
      });
    }

    function animate() {
      requestAnimationFrame(animate);

      // Process events that were previously queued.
      // Note: we may eventually desire to update the world (process animations, etc.)
      // before processing events.  Howerver, this is a) debatable, and b) Three.js doesn't
      // support this very well, since scene-update is bundled into render().
      while(eventQueue.length) {
        var event = eventQueue.shift();
        if (event.type !== "mouseDown") {
          console.log("only mouseDown is currently handled");
        }
        //
        var vector = new THREE.Vector3(event.x, event.y, 0.5);
        projector.unprojectVector(vector, camera);
        var ray = new THREE.Ray(camera.position, vector.subSelf(camera.position).normalize());
        var intersects = ray.intersectScene(scene);
        if (intersects.length > 0) {
          var vect = page.matrixWorld.makeInvert().multiplyVector3(intersects[0].point);
          vect = page.camera.projectionMatrix.makeInvert().multiplyVector3(vect);
          console.log("INTERSECTION! " + vect);

          var cubeGeometry = new THREE.CubeGeometry(0.1, 0.1, 0.1);
          var cube1 = new THREE.Mesh(cubeGeometry, new THREE.MeshLambertMaterial({ color: 0x0000ff })); 

          // This will be encapsulated in the Page class.
          if (page.width > page.height) {
            cube1.position.x = vect.x * 2 / page.width;
            cube1.position.y = vect.y * -2;
          }
          else {
            cube1.position.x = vect.x * 2;
            cube1.position.y = vect.y * -2 / page.height;
          }

          cube1.position.z = 1;
          page.scene.addObject(cube1);
        }
        else {
          console.log("NO INTERSECTION :-(");
        }

      }

      render();
    }

    function render() {
      renderer.render(scene, camera);
    }

    </script>
    
  </body>
</html>